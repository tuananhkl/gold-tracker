version: '3.9'

services:
  postgres:
    build:
      context: ./docker/postgres
    image: gold-tracker-postgres:16
    container_name: gold-tracker-postgres
    environment:
      POSTGRES_USER: gold
      POSTGRES_PASSWORD: gold
      POSTGRES_DB: gold
      TZ: UTC
    ports:
      - "5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U gold -d gold"]
      interval: 5s
      timeout: 5s
      retries: 20
    volumes:
      - pgdata:/var/lib/postgresql/data

  flyway:
    image: flyway/flyway:10
    container_name: gold-tracker-flyway
    depends_on:
      postgres:
        condition: service_healthy
    volumes:
      - ./db/flyway/sql:/flyway/sql:ro
    # Run all sprint-1 migrations into schema gold + public, retry until pg is ready
    command: >
      -url=jdbc:postgresql://postgres:5432/gold
      -user=gold
      -password=gold
      -locations=filesystem:/flyway/sql
      -defaultSchema=gold
      -schemas=gold,public
      -baselineOnMigrate=true
      -connectRetries=20
      migrate

  # One-shot test runner for pgTAP (optional but runnable via compose run)
  pgtap-runner:
    build:
      context: ./docker/pgtap-runner
    image: gold-tracker-pgtap-runner:latest
    container_name: gold-tracker-pgtap-runner
    depends_on:
      postgres:
        condition: service_healthy
      flyway:
        condition: service_completed_successfully
    environment:
      PGHOST: postgres
      PGPORT: 5432
      PGUSER: gold
      PGPASSWORD: gold
      PGDATABASE: gold
    volumes:
      - ./db/tests:/tests:ro
    entrypoint: ["/bin/sh","-c"]
    command: 'cd /tests && pg_prove -h postgres -d gold -U gold -p 5432 *.sql'

  api:
    build:
      context: .
      dockerfile: src/GoldTracker.Api/Dockerfile
    image: gold-tracker-api:dev
    container_name: gold-tracker-api
    depends_on:
      flyway:
        condition: service_completed_successfully
    environment:
      ASPNETCORE_ENVIRONMENT: Development
      ASPNETCORE_URLS: http://+:8080
      # use DB from compose; Program.cs should read POSTGRES_CONN
      POSTGRES_CONN: Host=postgres;Port=5432;Username=gold;Password=gold;Database=gold
      SCRAPER_ENABLED: "false"
      SNAPSHOT_ENABLED: "false"
      TZ: Asia/Ho_Chi_Minh
    ports:
      - "8080:8080"
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://localhost:8080/healthz"]
      interval: 5s
      timeout: 5s
      retries: 20

volumes:
  pgdata:
